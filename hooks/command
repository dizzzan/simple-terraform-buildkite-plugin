#!/usr/bin/env bash
set -eu -o pipefail

DEFAULT_INIT_ARGS="-input=false"
DEFAULT_VALIDATE_ARGS=""
DEFAULT_PLAN_ARGS="-input=false -out=tfplan.out"
DEFAULT_APPLY_ARGS="-input=false -auto-approve tfplan.out"
DEFAULT_DESTROY_ARGS="-input=false -auto-approve"

PATH="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_PATH}"
GROUP="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_GROUP:-}"
VALIDATE="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_VALIDATE:-true}"
INIT="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_INIT:-true}"
PLAN="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_PLAN:-true}"
APPLY="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_APPLY:-false}"
DESTROY="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_DESTROY:-false}"
BLOCK="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_BLOCK:-false}"
WAIT="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_WAIT:-true}"
INIT_ARGS="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_INIT_ARGS:${DEFAULT_INIT_ARGS}}"
VALIDATE_ARGS="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_VALIDATE_ARGS:${DEFAULT_VALIDATE_ARGS}}"
PLAN_ARGS="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_PLAN_ARGS:${DEFAULT_PLAN_ARGS}}"
APPLY_ARGS="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_APPLY_ARGS:${DEFAULT_APPLY_ARGS}}"
DESTROY_ARGS="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_DESTROY_ARGS:${DEFAULT_DESTROY_ARGS}}"
PROPAGATE_AWS_AUTH_TOKENS="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_PROPAGATE_AWS_CREDENTIALS:-true}"
PROPAGATE_ENVIRONMENT="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_PROPAGATE_ENVIRONMENT:-true}"

TERRAFORM_VERSION="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_TERRAFORM_VERSION:-latest}"
DOCKER_VERSION="${BUILDKITE_PLUGIN_SIMPLE_TERRAFORM_DOCKER_VERSION:-latest}"
DOCKER_PLUGIN_VERSION=$([ "$DOCKER_VERSION" = "latest" ] && echo "" || echo "#v${DOCKER_VERSION}")

DOCKER_PLUGIN_BLOCK=<<<EOF
${INDENT}plugins:
${INDENT}- docker${DOCKER_PLUGIN_VERSION}:
${INDENT}    image: "hashicorp/terraform:${TERRAFORM_VERSION}"
${INDENT}    volumes: 
${INDENT}      - ${PATH}:/workdir
${INDENT}    mount-workdir: false
${INDENT}    workdir: /workdir
${INDENT}    propagate-environment: true
EOF            
OUT=$'steps:\n'
INDENT=$([ "$GROUP" ] && echo "      " || echo "  ")

if [ "$GROUP" ]; then
  OUT+='  - group: "'$GROUP'"\n'
  OUT+='    steps:\n'
fi

# if [ "$VALIDATE" = "true" ]; then
#   OUT+=$INDENT'- label: "terraform validate"\n'
#   OUT+=$INDENT'  command: "terraform validate '"$VALIDATE_ARGS"'"'
#   OUT+=$'

echo "$OUT" | buildkite-agent pipeline upload